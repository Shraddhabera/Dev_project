{% extends 'base.html' %}

{% block title %}{{ problem.title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Title and Metadata -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="fw-bold">{{ problem.title }}</h1>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <span class="badge 
                    {% if problem.difficulty == 'Easy' %}bg-success 
                    {% elif problem.difficulty == 'Medium' %}bg-warning text-dark 
                    {% else %}bg-danger{% endif %} px-3 py-2 fs-6">
                    {{ problem.difficulty }}
                </span>
                <span class="text-muted small">
                    üßë‚Äçüíª Posted by <strong>{{ problem.author.username }}</strong> on {{ problem.created_at|date:"M d, Y" }}
                </span>
            </div>
        </div>
    </div>

    <!-- Description -->
    <div class="card shadow-sm rounded mb-4">
        <div class="card-body">
            <h4 class="fw-semibold mb-3">üìò Description</h4>
            <div class="text-muted">{{ problem.description|linebreaks }}</div>
        </div>
    </div>

    <!-- Input/Output -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm rounded mb-4">
                <div class="card-body">
                    <h5 class="fw-semibold">üîΩ Input</h5>
                    <div class="text-muted">{{ problem.input_description|linebreaks }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm rounded mb-4">
                <div class="card-body">
                    <h5 class="fw-semibold">üîº Output</h5>
                    <div class="text-muted">{{ problem.output_description|linebreaks }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sample I/O -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm rounded mb-4">
                <div class="card-body">
                    <h5 class="fw-semibold">üì• Sample Input</h5>
                    <pre class="bg-light rounded p-3 border">{{ problem.sample_input }}</pre>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm rounded mb-4">
                <div class="card-body">
                    <h5 class="fw-semibold">üì§ Sample Output</h5>
                    <pre class="bg-light rounded p-3 border">{{ problem.sample_output }}</pre>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_authenticated %}
    <!-- Submission Form -->
    <div class="card shadow-sm rounded mb-4">
        <div class="card-body">
            <h4 class="fw-semibold mb-3">üìù Submit Your Solution</h4>

            <div class="mb-3">
                <label for="language" class="form-label fw-medium">Language</label>
                <select id="language" class="form-select">
                    <option value="python">Python</option>
                    <option value="cpp">C++</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="input" class="form-label fw-medium">Custom Input (optional)</label>
                <textarea id="input" class="form-control" rows="3" placeholder="Leave blank to use sample input">{{ sample_input }}</textarea>
            </div>

            <div class="mb-3">
                <label for="code" class="form-label fw-medium">Code</label>
                <textarea id="code" class="form-control" rows="10">{{ default_code }}</textarea>
            </div>

            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-primary" onclick="runCode()">‚ñ∂Ô∏è Run Code</button>
                <button type="button" class="btn btn-primary" onclick="runAllTestCases()">üîÅ Run All Tests</button>
                <button type="button" class="btn btn-success" onclick="submitCode()">‚úÖ Submit Code</button>
                <button type="button" class="btn btn-info text-white" onclick="getAIReview()" id="ai-review-btn">ü§ñ Get AI Review</button>
            </div>
        </div>
    </div>

    <!-- Output & Verdict -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm rounded mb-4">
                <div class="card-body">
                    <h5 class="fw-semibold">üíª Run Output</h5>
                    <pre id="run-output" class="bg-light rounded p-3 border"></pre>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm rounded mb-4">
                <div class="card-body">
                    <h5 class="fw-semibold">üéØ Test Results</h5>
                    <div id="test-results" class="bg-light rounded p-3 border"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Review -->
    <div class="card shadow-sm rounded mb-4">
        <div class="card-body">
            <h5 class="fw-semibold">üß† AI Code Review</h5>
            <div id="ai-review-loading" class="d-none text-center my-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Generating AI review...</p>
            </div>
            <div id="ai-review-content" class="card-text mt-3"></div>
        </div>
    </div>
    {% else %}
        <a href="{% url 'login' %}?next={% url 'problems:problem_detail' problem.id %}" class="btn btn-primary">Login to Submit</a>
    {% endif %}

    <div class="text-end mt-4">
        <a href="{% url 'problems:problem_list' %}" class="btn btn-outline-secondary">‚¨ÖÔ∏è Back to Problems</a>
    </div>
</div>

<script>
// function runCode() {
//     const code = document.getElementById("code").value;
//     const language = document.getElementById("language").value;
//     const custom_input = document.getElementById("input").value;
//     const output = document.getElementById("run-output");

//     output.innerText = "Running...";

//     fetch("{% url 'problems:run_code' problem.id %}", {
//         method: 'POST',
//         headers: {
//             'Content-Type': 'application/json',
//             'X-CSRFToken': '{{ csrf_token }}'
//         },
//         body: JSON.stringify({ code, custom_input, language })
//     })
//     .then(res => res.json())
//     .then(data => {
//         output.innerText = data.error ? "Error:\n" + data.error : data.output;
//     })
//     .catch(error => {
//         output.innerText = "Error running code: " + error.message;
//     });
// }

function runCode() {
    const code = document.getElementById("code").value;
    const language = document.getElementById("language").value;
    let custom_input = document.getElementById("input").value.trim();
    const output = document.getElementById("run-output");

    output.innerText = "Running...";

    // Use sample input if custom input is empty
    if (custom_input === "") {
        custom_input = `{{ sample_testcase.input_data|escapejs }}`;
    }

    fetch("{% url 'problems:run_code' problem.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ code, custom_input, language })
    })
    .then(res => res.json())
    .then(data => {
        output.innerText = data.error ? "Error:\n" + data.error : data.output;
    })
    .catch(error => {
        output.innerText = "Error running code: " + error.message;
    });
}


// function runAllTestCases() {
//     const code = document.getElementById("code").value;
//     const language = document.getElementById("language").value;
//     const resultsDiv = document.getElementById("test-results");

//     resultsDiv.innerHTML = "<p>Running all test cases...</p>";

//     fetch("{% url 'problems:run_all_testcases' problem.id %}", {
//         method: 'POST',
//         headers: {
//             'Content-Type': 'application/json',
//             'X-CSRFToken': '{{ csrf_token }}'
//         },
//         body: JSON.stringify({ code, language })
//     })
//     .then(res => res.json())
//     .then(data => {
//         let html = `<div class="mb-2"><strong>Results:</strong> ${data.passed}/${data.total} passed</div>`;
        
//         data.results.forEach((result, index) => {
//             html += `
//             <div class="test-case mb-3 p-2 ${result.verdict === 'Passed' ? 'bg-success-light' : 'bg-danger-light'}">
//                 <h6>Test Case ${index + 1} ${result.is_sample ? '(Sample)' : ''}</h6>
//                 <div class="mb-1"><strong>Input:</strong> ${result.input}</div>
//                 <div class="mb-1"><strong>Expected:</strong> ${result.expected_output}</div>
//                 <div class="mb-1"><strong>Output:</strong> ${result.output}</div>
//                 <div><strong>Verdict:</strong> 
//                     <span class="badge ${result.verdict === 'Passed' ? 'bg-success' : 'bg-danger'}">
//                         ${result.verdict}
//                     </span>
//                 </div>
//                 ${result.error ? `<div class="text-danger mt-1"><strong>Error:</strong> ${result.error}</div>` : ''}
//             </div>`;
//         });

//         resultsDiv.innerHTML = html;
//     })
//     .catch(error => {
//         resultsDiv.innerHTML = `<div class="alert alert-danger">Error running test cases: ${error.message}</div>`;
//     });
// }

function runAllTestCases() {
    const code = document.getElementById("code").value;
    const language = document.getElementById("language").value;
    const resultsDiv = document.getElementById("test-results");

    resultsDiv.innerHTML = "<p>Running all test cases...</p>";

    fetch("{% url 'problems:run_all_testcases' problem.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ code, language })
    })
    .then(res => res.json())
    .then(data => {
        let html = `<div class="mb-3"><strong>Results:</strong> ${data.passed}/${data.total} test cases passed</div>`;

        data.results.forEach((result, index) => {
            html += `
            <div class="test-case mb-2 p-3 rounded border ${result.verdict === 'Passed' ? 'border-success' : 'border-danger'}">
                <strong>Test Case ${index + 1}:</strong> 
                <span class="badge ${result.verdict === 'Passed' ? 'bg-success' : 'bg-danger'}">
                    ${result.verdict}
                </span><br>`;

            if (result.is_sample) {
                html += `
                    <div class="mt-2"><strong>Input:</strong><pre>${result.input}</pre></div>
                    <div><strong>Expected Output:</strong><pre>${result.expected_output}</pre></div>
                    <div><strong>Your Output:</strong><pre>${result.output}</pre></div>
                    ${result.error ? `<div><strong>Error:</strong><pre>${result.error}</pre></div>` : ''}
                `;
            } else {
                html += `<div class="text-muted mt-1"><em>Hidden test case</em></div>`;
            }

            html += `</div>`;
        });

        resultsDiv.innerHTML = html;
    })
    .catch(error => {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error running test cases: ${error.message}</div>`;
    });
}



function submitCode() {
    const code = document.getElementById("code").value;
    const language = document.getElementById("language").value;
    const resultsDiv = document.getElementById("test-results");
    const submitBtn = document.querySelector("button[onclick='submitCode()']");

    submitBtn.disabled = true;
    resultsDiv.innerHTML = "<p>Submitting and running all test cases...</p>";

    fetch("{% url 'problems:submit_code' problem.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ code, language })
    })
    .then(res => res.json())
    .then(data => {
        let html = `<div class="mb-2">
            <strong>Final Verdict:</strong> 
            <span class="badge ${data.verdict === 'Accepted' ? 'bg-success' : 
                              data.verdict === 'Partial Answer' ? 'bg-warning text-dark' : 'bg-danger'}">
                ${data.verdict}
            </span>
            (${data.score})
        </div>`;
        
        data.results.forEach((result, index) => {
            html += `
            <div class="test-case mb-3 p-2 ${result.verdict === 'Passed' ? 'bg-success-light' : 'bg-danger-light'}">
                <h6>Test Case ${index + 1}</h6>
                <div class="mb-1"><strong>Input:</strong> ${result.input}</div>
                <div class="mb-1"><strong>Expected:</strong> ${result.expected_output}</div>
                <div class="mb-1"><strong>Output:</strong> ${result.output}</div>
                <div><strong>Verdict:</strong> 
                    <span class="badge ${result.verdict === 'Passed' ? 'bg-success' : 'bg-danger'}">
                        ${result.verdict || result.error}
                    </span>
                </div>
                ${result.error ? `<div class="text-danger mt-1"><strong>Error:</strong> ${result.error}</div>` : ''}
            </div>`;
        });

        resultsDiv.innerHTML = html;
        
        // Redirect to submissions page after 2 seconds if successful
        if (data.verdict === 'Accepted') {
            setTimeout(() => {
                window.location.href = "{% url 'problems:user_submissions' %}";
            }, 2000);
        }
    })
    .catch(error => {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error submitting code: ${error.message}</div>`;
    })
    .finally(() => {
        submitBtn.disabled = false;
    });
}

function getAIReview() {
    const code = document.getElementById("code").value;
    const language = document.getElementById("language").value;
    const btn = document.getElementById("ai-review-btn");
    const loading = document.getElementById("ai-review-loading");
    const content = document.getElementById("ai-review-content");

    btn.disabled = true;
    loading.classList.remove("d-none");
    content.innerHTML = "";

    fetch("{% url 'problems:ai_review' problem.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ code, language })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        } else {
            // Format the markdown response with line breaks
            const formattedReview = data.review.replace(/\n/g, '<br>');
            content.innerHTML = `<div class="alert alert-success">${formattedReview}</div>`;
        }
    })
    .catch(error => {
        content.innerHTML = `<div class="alert alert-danger">Error fetching AI review: ${error}</div>`;
    })
    .finally(() => {
        loading.classList.add("d-none");
        btn.disabled = false;
    });
}
</script>

<style>
.bg-success-light {
    background-color: rgba(25, 135, 84, 0.1);
    border-left: 3px solid #198754;
}
.bg-danger-light {
    background-color: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
}
.test-case {
    border-radius: 4px;
}
pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}
</style>

{% endblock %}
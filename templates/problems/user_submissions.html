{% extends "base.html" %}

{% block content %}
<div class="container my-5">
    <div class="card shadow-sm rounded">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-code me-2"></i>
                <h3 class="mb-0">My Submissions</h3>
            </div>
            <div>
                <span class="badge bg-light text-dark me-2">
                    <i class="fas fa-check-circle text-success me-1"></i>
                    {{ accepted_count }} Accepted
                </span>
                <span class="badge bg-light text-dark">
                    <i class="fas fa-list-ol me-1"></i>
                    {{ submissions|length }} Total
                </span>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if submissions %}
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" width="35%">Problem</th>
                            <th scope="col" width="15%">Language</th>
                            <th scope="col" width="25%">Verdict</th>
                            <th scope="col" width="25%">Submitted</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in submissions %}
                        <tr class="align-middle">
                            <td>
                                <a href="{% url 'problems:problem_detail' sub.problem.id %}" class="text-decoration-none">
                                    <strong>{{ sub.problem.title }}</strong>
                                </a>
                                <div class="text-muted small mt-1">
                                    Difficulty: 
                                    <span class="badge 
                                        {% if sub.problem.difficulty == 'easy' %}bg-success
                                        {% elif sub.problem.difficulty == 'medium' %}bg-warning text-dark
                                        {% else %}bg-danger
                                        {% endif %}">
                                        {{ sub.problem.difficulty|title }}
                                    </span>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info text-dark">
                                    {{ sub.language|upper }}
                                </span>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if sub.verdict == 'Accepted' %}bg-success
                                    {% elif sub.verdict == 'Wrong Answer' %}bg-danger
                                    {% elif sub.verdict == 'Time Limit Exceeded' %}bg-warning text-dark
                                    {% elif sub.verdict == 'Runtime Error' %}bg-dark
                                    {% elif sub.verdict == 'Compilation Error' %}bg-secondary
                                    {% else %}bg-primary
                                    {% endif %}">
                                    {% if sub.verdict == 'Accepted' %}
                                        <i class="fas fa-check-circle me-1"></i>
                                    {% elif sub.verdict == 'Wrong Answer' %}
                                        <i class="fas fa-times-circle me-1"></i>
                                    {% elif sub.verdict == 'Time Limit Exceeded' %}
                                        <i class="fas fa-clock me-1"></i>
                                    {% endif %}
                                    {{ sub.verdict }}
                                </span>
                                {% if sub.verdict == 'Wrong Answer' %}
                                <button class="btn btn-sm btn-outline-secondary ms-2" data-bs-toggle="tooltip" 
                                    title="View code" onclick="showCodeModal('{{ sub.code|escapejs }}', '{{ sub.language }}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% endif %}
                            </td>
                            <td>
                                <div class="text-muted">{{ sub.created_at|date:"M d, Y" }}</div>
                                <div class="small">{{ sub.created_at|date:"H:i" }}</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
            <div class="p-3 border-top">
                <nav aria-label="Submission pagination">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <div class="p-5 text-center text-muted">
                <i class="fas fa-file-code fa-3x mb-3"></i>
                <h5>No submissions found</h5>
                <p class="mb-0">Try solving some problems to see your submissions here!</p>
                <a href="{% url 'problem_list' %}" class="btn btn-primary mt-3">
                    <i class="fas fa-arrow-right me-1"></i> Browse Problems
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Code Modal -->
<div class="modal fade" id="codeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Submission Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <pre id="codeContent" class="m-0 p-3"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyCode()">
                    <i class="fas fa-copy me-1"></i> Copy Code
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Show code in modal
function showCodeModal(code, language) {
    const codeContent = document.getElementById('codeContent');
    codeContent.textContent = code;
    codeContent.className = `m-0 p-3 language-${language.toLowerCase()}`;
    
    // Highlight syntax if using Prism.js or similar
    if (typeof Prism !== 'undefined') {
        Prism.highlightElement(codeContent);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('codeModal'));
    modal.show();
}

// Copy code to clipboard
function copyCode() {
    const codeContent = document.getElementById('codeContent');
    navigator.clipboard.writeText(codeContent.textContent)
        .then(() => {
            const copyBtn = document.querySelector('#codeModal .btn-primary');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check me-1"></i> Copied!';
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
            }, 2000);
        });
}
</script>
{% endblock %}